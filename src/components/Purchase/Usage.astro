---
import {Icon} from 'astro-icon/components'
import {usage} from '~constants/usage'

const {class: classes} = Astro.props
---

<div class='flex flex-col lg:pt-16' class:list={[classes]} data-usage-timeline>
  {
    usage.map((item, index) => (
      <div class='flex gap-4'>
        <div class='flex flex-col items-center'>
          <div
            class='relative z-10 flex justify-center items-center h-10 w-10 lg:h-14 lg:w-14'
            class:list={[index === 0 ? 'text-primary-dark' : 'text-dark']}
            data-usage-step
          >
            <svg class='absolute inset-0 h-full w-full' viewBox='0 0 40 40' aria-hidden='true'>
              {index === 0 ? (
                <circle
                  cx='20'
                  cy='20'
                  r='19'
                  stroke-width='2'
                  class='stroke-primary-dark'
                  vector-effect='non-scaling-stroke'
                  fill='none'
                />
              ) : (
                <>
                  <circle
                    cx='20'
                    cy='20'
                    r='19'
                    stroke-width='2'
                    class='stroke-dark'
                    vector-effect='non-scaling-stroke'
                    fill='none'
                  />
                  <circle
                    data-usage-ring
                    cx='20'
                    cy='20'
                    r='19'
                    stroke-width='2'
                    class='stroke-primary-dark'
                    vector-effect='non-scaling-stroke'
                    fill='none'
                    style='opacity: 0;'
                  />
                </>
              )}
            </svg>
            <Icon name='card' class='relative z-10 h-[23px] w-[23px] lg:h-8 lg:w-8' />
          </div>
          {item.line && (
            <div class='relative z-0 w-0.5 flex-1 bg-dark overflow-hidden -mt-[1px]'>
              <div
                data-usage-line
                class='absolute left-0 top-0 w-full bg-primary-dark'
                style='height: 0;'
              />
            </div>
          )}
        </div>
        <div class='flex flex-col gap-3'>
          <h4 class='text-lg lg:text-2xl font-semibold leading-7 lg:leading-normal'>
            {item.title}
          </h4>
          <p
            class='text-gray-dark leading-snug pb-6 lg:text-lg'
            class:list={[item.line && 'lg:pb-16']}
          >
            {item.contents}
          </p>
        </div>
      </div>
    ))
  }
</div>

<script>
  const timeline = document.querySelector('[data-usage-timeline]')
  const steps = timeline ? Array.from(timeline.querySelectorAll('[data-usage-step]')) : []
  const lines = timeline ? Array.from(timeline.querySelectorAll('[data-usage-line]')) : []
  const rings = steps.map((step) => step.querySelector('[data-usage-ring]'))

  const updateTimeline = () => {
    if (!timeline) return
    const trigger = window.innerHeight * 0.6

    lines.forEach((line) => {
      const rect = line.parentElement?.getBoundingClientRect()
      if (!rect) return
      const filled = Math.min(Math.max(trigger - rect.top, 0), rect.height)
      line.style.height = `${filled}px`
    })

    steps.forEach((step, index) => {
      if (index === 0) return
      const ring = rings[index]
      if (!ring) return
      const rect = step.getBoundingClientRect()
      const active = trigger >= rect.top
      ring.style.opacity = active ? '1' : '0'
    })
  }

  updateTimeline()
  window.addEventListener('scroll', updateTimeline, {passive: true})
  window.addEventListener('resize', updateTimeline)
</script>
